解析一条查询SQL在关系型分布式数据库starrocks中的处理过程

### 步骤

1、将SQL文本转换成一个“最佳的”分布式物理执行计划

2、将执行计划调度到计算节点

3、计算节点执行具体的物理执行计划



### 将SQL语句转换为物理执行计划

在starrocks中，需要经过以下五个步骤：

1、SQL parse：将SQL语句转换成一个AST（Abstract syntax tree，抽象语法树）

2、SQL Analyze：基于 AST 进行语法和语义分析

3、SQL Logical Plan：将 AST 转换成逻辑计划

4、 SQL Optimize：基于关系代数、统计信息、Cost 模型，对逻辑计划进行重写、转换，选择出 Cost “最低” 的物理执行计划

5、生成 Plan Fragment：将 Optimizer 选择的物理执行计划转换为 BE 可以直接执行的 Plan Fragment



### 将执行加护调度到计算节点





### 计算节点执行具体的物理执行计划

StarRocks 是通过 MPP 多机并行机制来充分利用多机的资源，**通过 Pipeline 并行机制来充分利用单机上多核的资源，通过向量化执行来充分利用单核的资源，**进而达到极致的查询性能。

效率优化手段：

- 通过 MPP 分布式执行框架充分利用多机的资源，做到查询性能可以随着机器数量近似线性扩展。StarRocks 会将一个查询在逻辑上切分为多个 Query Fragment（查询片段），每个 Query Fragment 可以有一个或者多个 Fragment 执行实例，每个 Fragment 执行实例会被调度到集群某个 BE 上执行
- 通过 Pipeline 并行执行框架充分利用多核资源，做到查询性能可以随着机器核数近似线性扩展。Pipeline 并行执行框架的核心是实现一个用户态的协程调度，不再依赖操作系统的内核态线程调度，减少线程创建、线程销毁、线程上下文切换的成本。
- 通过向量化执行引擎充分利用 CPU 单核资源，将单核执行性能做到极致







### 疑问

为什么要用多级反馈就绪队列？按照自己的理解，无非就是用户级线程的调度，既然这样，为什么不参考内核的CFS算法？